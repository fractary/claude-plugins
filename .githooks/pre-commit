#!/bin/bash

# Pre-commit hook: Auto-fix shell script permissions
# This hook ensures all .sh files have executable permissions in git
#
# To enable: git config core.hooksPath .githooks

# Get list of staged .sh files
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)

if [ -z "$STAGED_SH_FILES" ]; then
    exit 0
fi

FIXED_FILES=()

for file in $STAGED_SH_FILES; do
    # Check if file exists (not deleted)
    if [ -f "$file" ]; then
        # Get current mode in git index
        MODE=$(git ls-files -s "$file" 2>/dev/null | awk '{print $1}')

        if [ "$MODE" = "100644" ]; then
            # File is not executable, fix it
            git update-index --chmod=+x "$file"
            FIXED_FILES+=("$file")
        fi
    fi
done

if [ ${#FIXED_FILES[@]} -gt 0 ]; then
    echo "Auto-fixed executable permissions on shell scripts:"
    for file in "${FIXED_FILES[@]}"; do
        echo "  +x $file"
    done
    echo ""
    echo "Permissions have been staged. Proceeding with commit."
fi

exit 0
