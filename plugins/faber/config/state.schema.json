{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "FABER Workflow State Schema",
  "description": "Schema for tracking current workflow execution state",
  "type": "object",
  "required": ["target", "workflow_version", "status", "started_at"],
  "properties": {
    "target": {
      "type": "string",
      "description": "What is being worked on - artifact name, module, dataset, or description"
    },
    "work_id": {
      "type": ["string", "null"],
      "description": "Work item identifier (optional - provides issue context)"
    },
    "issue_number": {
      "type": "string",
      "description": "External issue number (e.g., GitHub issue #123)"
    },
    "workflow_version": {
      "type": "string",
      "description": "FABER workflow version (e.g., '2.0')"
    },
    "config_hash": {
      "type": "string",
      "description": "Hash of configuration file for consistency checking"
    },
    "status": {
      "type": "string",
      "enum": ["in_progress", "paused", "completed", "failed", "cancelled"],
      "description": "Overall workflow status"
    },
    "current_phase": {
      "type": "string",
      "enum": ["frame", "architect", "build", "evaluate", "release", "none"],
      "description": "Current phase being executed"
    },
    "current_step": {
      "type": "string",
      "description": "Current sub-step name within phase"
    },
    "current_step_id": {
      "type": "string",
      "pattern": "^(frame|architect|build|evaluate|release):[a-z][a-z0-9-]*$",
      "description": "Full step identifier in format 'phase:step-name' (e.g., 'build:implement')"
    },
    "additional_instructions": {
      "type": ["string", "null"],
      "description": "Custom prompt content provided via --prompt argument"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "Workflow start timestamp (ISO 8601)"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "Last update timestamp (ISO 8601)"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "Workflow completion timestamp (ISO 8601)"
    },
    "phases": {
      "type": "object",
      "description": "Phase-level state tracking",
      "properties": {
        "frame": {
          "$ref": "#/definitions/phase_state"
        },
        "architect": {
          "$ref": "#/definitions/phase_state"
        },
        "build": {
          "$ref": "#/definitions/phase_state"
        },
        "evaluate": {
          "$ref": "#/definitions/phase_state"
        },
        "release": {
          "$ref": "#/definitions/phase_state"
        }
      }
    },
    "pending_approvals": {
      "type": "array",
      "description": "Pending approval requests",
      "items": {
        "type": "object",
        "properties": {
          "phase": {
            "type": "string"
          },
          "reason": {
            "type": "string"
          },
          "requested_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "errors": {
      "type": "array",
      "description": "Errors encountered during workflow",
      "items": {
        "type": "object",
        "properties": {
          "phase": {
            "type": "string"
          },
          "step": {
            "type": "string"
          },
          "error": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "retries": {
      "type": "object",
      "description": "Retry tracking per phase",
      "additionalProperties": {
        "type": "integer"
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Artifacts created during workflow",
      "properties": {
        "branch": {
          "type": "string"
        },
        "spec_path": {
          "type": "string"
        },
        "commits": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "pr_number": {
          "type": "string"
        },
        "pr_url": {
          "type": "string"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional workflow metadata",
      "properties": {
        "autonomy_level": {
          "type": "string",
          "enum": ["dry-run", "assist", "guarded", "autonomous"],
          "description": "DEPRECATED: Legacy autonomy level"
        },
        "autonomy": {
          "type": "object",
          "description": "New two-dimensional autonomy configuration",
          "properties": {
            "check_in_frequency": {
              "type": "string",
              "enum": ["per-step", "per-phase", "end-only"]
            },
            "warning_tolerance": {
              "type": "string",
              "enum": ["none", "low", "medium", "high"]
            },
            "error_tolerance": {
              "type": "string",
              "enum": ["none", "low", "medium", "high"]
            }
          }
        },
        "manager_skill": {
          "type": "string"
        },
        "director_skill": {
          "type": "string"
        }
      }
    },
    "logs": {
      "type": "object",
      "description": "References to log entries for this workflow run",
      "properties": {
        "step_responses": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Array of step-response log IDs captured during execution"
        },
        "workflow_execution": {
          "type": "string",
          "description": "Workflow execution summary log ID (generated at completion)"
        }
      }
    },
    "response_totals": {
      "type": "object",
      "description": "Aggregated response counts for quick access",
      "properties": {
        "warnings": {
          "type": "integer",
          "minimum": 0,
          "description": "Total warning count across all steps"
        },
        "errors": {
          "type": "integer",
          "minimum": 0,
          "description": "Total error count across all steps"
        },
        "by_severity": {
          "type": "object",
          "properties": {
            "low": { "type": "integer", "minimum": 0 },
            "medium": { "type": "integer", "minimum": 0 },
            "high": { "type": "integer", "minimum": 0 }
          },
          "description": "Warning/error counts by severity level"
        },
        "by_category": {
          "type": "object",
          "additionalProperties": { "type": "integer", "minimum": 0 },
          "description": "Warning/error counts by category"
        }
      }
    },
    "limits_reached": {
      "type": "object",
      "description": "Tracks if any global limits were reached during execution",
      "properties": {
        "max_total_warnings": {
          "type": "object",
          "properties": {
            "limit": { "type": "integer" },
            "actual": { "type": "integer" },
            "action": { "type": "string", "enum": ["stop", "truncated"] }
          }
        },
        "max_total_errors": {
          "type": "object",
          "properties": {
            "limit": { "type": "integer" },
            "actual": { "type": "integer" },
            "action": { "type": "string", "enum": ["stop", "truncated"] }
          }
        }
      }
    },
    "last_check_in": {
      "type": "object",
      "description": "Tracks the last check-in point for accumulated response display",
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "phase": {
          "type": "string"
        },
        "step": {
          "type": "string"
        }
      }
    }
  },
  "definitions": {
    "phase_state": {
      "type": "object",
      "description": "State of a single workflow phase",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "failed", "skipped"],
          "description": "Phase status"
        },
        "started_at": {
          "type": "string",
          "format": "date-time",
          "description": "Phase start timestamp"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time",
          "description": "Phase completion timestamp"
        },
        "current_step": {
          "type": "string",
          "description": "Current sub-step name within phase"
        },
        "current_step_id": {
          "type": "string",
          "description": "Full step identifier in format 'phase:step-name'"
        },
        "completed_steps": {
          "type": "array",
          "description": "List of completed sub-step names",
          "items": {
            "type": "string"
          }
        },
        "completed_step_ids": {
          "type": "array",
          "description": "List of completed step IDs in format 'phase:step-name'",
          "items": {
            "type": "string"
          }
        },
        "artifacts": {
          "type": "array",
          "description": "Artifacts created in this phase",
          "items": {
            "type": "string"
          }
        },
        "hooks_executed": {
          "type": "object",
          "description": "Hooks executed in this phase",
          "properties": {
            "pre": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "post": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "error": {
          "type": "string",
          "description": "Error message if phase failed"
        }
      }
    }
  }
}
