{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://fractary.dev/schemas/docs/etl.schema.json",
  "title": "ETL Documentation Schema",
  "description": "Schema for ETL/data pipeline documentation with dual-format support (README.md + etl.json)",
  "type": "object",
  "required": ["etl_name", "version", "description", "pipeline_definition"],
  "properties": {
    "etl_name": {
      "type": "string",
      "description": "Name of the ETL process or pipeline",
      "minLength": 1,
      "maxLength": 100,
      "pattern": "^[a-z0-9-]+$"
    },
    "version": {
      "type": "string",
      "description": "Semantic version of the ETL pipeline",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "etl_type": {
      "type": "string",
      "description": "Type of ETL platform/framework",
      "enum": ["glue", "airflow", "dbt", "lambda", "step-functions", "databricks", "custom"]
    },
    "description": {
      "type": "string",
      "description": "Technical description of what this ETL process does"
    },
    "pipeline_definition": {
      "type": "object",
      "description": "Definition of the data pipeline flow",
      "required": ["source", "transformations", "destination"],
      "properties": {
        "source": {
          "type": "object",
          "description": "Data source configuration",
          "required": ["type", "location"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["s3", "rds", "dynamodb", "redshift", "api", "kafka", "kinesis", "file", "database"]
            },
            "location": {
              "type": "string",
              "description": "S3 URI, connection string, or endpoint"
            },
            "schema_reference": {
              "type": "string",
              "description": "Link to dataset documentation"
            },
            "format": {
              "type": "string",
              "description": "Data format (json, csv, parquet, avro, etc.)"
            }
          }
        },
        "transformations": {
          "type": "array",
          "description": "Ordered list of transformation steps",
          "items": {
            "type": "object",
            "required": ["step", "operation", "description"],
            "properties": {
              "step": {
                "type": "integer",
                "description": "Step number in sequence"
              },
              "operation": {
                "type": "string",
                "description": "Type of transformation",
                "enum": ["filter", "join", "aggregate", "deduplicate", "enrich", "pivot", "union", "custom"]
              },
              "description": {
                "type": "string",
                "description": "What this transformation does"
              },
              "logic": {
                "type": "string",
                "description": "SQL query, code snippet, or reference to implementation"
              },
              "parameters": {
                "type": "object",
                "description": "Configuration parameters for this transformation"
              }
            }
          }
        },
        "destination": {
          "type": "object",
          "description": "Data destination configuration",
          "required": ["type", "location"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["s3", "rds", "dynamodb", "redshift", "snowflake", "bigquery", "database"]
            },
            "location": {
              "type": "string",
              "description": "S3 URI, connection string, or table name"
            },
            "schema_reference": {
              "type": "string",
              "description": "Link to output dataset documentation"
            },
            "format": {
              "type": "string",
              "description": "Output data format"
            },
            "write_mode": {
              "type": "string",
              "enum": ["overwrite", "append", "upsert"],
              "description": "How data is written to destination"
            }
          }
        }
      }
    },
    "schedule": {
      "type": "object",
      "description": "Execution schedule and dependencies",
      "properties": {
        "frequency": {
          "type": "string",
          "enum": ["realtime", "continuous", "hourly", "daily", "weekly", "monthly", "event-driven", "manual"],
          "description": "How often the ETL runs"
        },
        "cron": {
          "type": "string",
          "description": "Cron expression for scheduled runs"
        },
        "timezone": {
          "type": "string",
          "description": "Timezone for schedule (e.g., UTC, America/New_York)",
          "default": "UTC"
        },
        "dependencies": {
          "type": "array",
          "description": "Upstream jobs that must complete first",
          "items": {
            "type": "string"
          }
        },
        "triggers": {
          "type": "array",
          "description": "Events that trigger execution",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["file-arrival", "time-based", "api-call", "data-change"]
              },
              "configuration": {
                "type": "object"
              }
            }
          }
        }
      }
    },
    "data_quality": {
      "type": "object",
      "description": "Data quality checks and validation rules",
      "properties": {
        "validation_rules": {
          "type": "array",
          "description": "Rules to validate data quality",
          "items": {
            "type": "object",
            "required": ["rule", "severity"],
            "properties": {
              "rule": {
                "type": "string",
                "description": "Validation rule expression (e.g., 'row_count > 1000')"
              },
              "severity": {
                "type": "string",
                "enum": ["error", "warning", "info"],
                "description": "What happens if rule fails"
              },
              "description": {
                "type": "string"
              }
            }
          }
        },
        "quality_checks": {
          "type": "array",
          "description": "Automated quality checks",
          "items": {
            "type": "object",
            "properties": {
              "check_name": {
                "type": "string"
              },
              "check_type": {
                "type": "string",
                "enum": ["completeness", "uniqueness", "consistency", "validity", "timeliness"]
              },
              "threshold": {
                "type": "number",
                "description": "Acceptable threshold (percentage or count)"
              }
            }
          }
        }
      }
    },
    "error_handling": {
      "type": "object",
      "description": "Error handling and retry configuration",
      "properties": {
        "retry_policy": {
          "type": "object",
          "properties": {
            "max_retries": {
              "type": "integer",
              "minimum": 0
            },
            "backoff": {
              "type": "string",
              "enum": ["linear", "exponential", "fixed"]
            },
            "retry_interval_seconds": {
              "type": "integer"
            }
          }
        },
        "alerts": {
          "type": "object",
          "properties": {
            "channels": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["slack", "email", "pagerduty", "sns", "teams"]
              }
            },
            "thresholds": {
              "type": "object",
              "description": "When to trigger alerts (failure count, duration, etc.)"
            }
          }
        },
        "failure_procedures": {
          "type": "string",
          "description": "What to do when ETL fails"
        }
      }
    },
    "performance": {
      "type": "object",
      "description": "Performance characteristics and requirements",
      "properties": {
        "avg_runtime": {
          "type": "string",
          "description": "Average execution time (e.g., '15 minutes')"
        },
        "data_volume_per_run": {
          "type": "string",
          "description": "Typical data volume processed (e.g., '10GB')"
        },
        "resource_requirements": {
          "type": "object",
          "properties": {
            "workers": {
              "type": "integer",
              "description": "Number of parallel workers"
            },
            "memory_gb": {
              "type": "number",
              "description": "Memory requirement in GB"
            },
            "cpu_cores": {
              "type": "integer",
              "description": "CPU cores required"
            }
          }
        },
        "sla": {
          "type": "object",
          "properties": {
            "max_duration": {
              "type": "string",
              "description": "Maximum acceptable duration"
            },
            "availability_target": {
              "type": "string",
              "description": "Uptime SLA (e.g., '99.9%')"
            }
          }
        }
      }
    },
    "monitoring": {
      "type": "object",
      "description": "Monitoring and observability",
      "properties": {
        "metrics": {
          "type": "array",
          "description": "Key metrics to monitor",
          "items": {
            "type": "string"
          }
        },
        "dashboards": {
          "type": "array",
          "description": "Links to monitoring dashboards",
          "items": {
            "type": "string"
          }
        },
        "logs": {
          "type": "object",
          "properties": {
            "log_group": {
              "type": "string",
              "description": "CloudWatch log group or equivalent"
            },
            "retention_days": {
              "type": "integer"
            }
          }
        }
      }
    },
    "code_references": {
      "type": "object",
      "description": "References to code implementation",
      "properties": {
        "repository": {
          "type": "string",
          "description": "Git repository URL"
        },
        "main_file": {
          "type": "string",
          "description": "Main ETL code file"
        },
        "version": {
          "type": "string",
          "description": "Code version or git tag"
        },
        "config_files": {
          "type": "array",
          "description": "Configuration file paths",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "lineage": {
      "type": "object",
      "description": "Data lineage information",
      "properties": {
        "upstream_datasets": {
          "type": "array",
          "description": "Source datasets",
          "items": {
            "type": "string"
          }
        },
        "downstream_datasets": {
          "type": "array",
          "description": "Output datasets",
          "items": {
            "type": "string"
          }
        },
        "lineage_graph_url": {
          "type": "string",
          "description": "Link to visual lineage graph"
        }
      }
    },
    "contacts": {
      "type": "object",
      "description": "Team and contact information",
      "properties": {
        "owner": {
          "type": "string",
          "description": "Team or person responsible"
        },
        "on_call": {
          "type": "string",
          "description": "On-call rotation or contact"
        },
        "slack_channel": {
          "type": "string"
        }
      }
    },
    "tags": {
      "type": "array",
      "description": "Tags for categorization",
      "items": {
        "type": "string"
      }
    },
    "created": {
      "type": "string",
      "description": "Creation timestamp",
      "format": "date-time"
    },
    "updated": {
      "type": "string",
      "description": "Last update timestamp",
      "format": "date-time"
    }
  }
}
