{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Codex Plugin Configuration",
  "description": "Configuration schema for the Fractary codex plugin - documentation and knowledge sync across organization projects",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "description": "Configuration version",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "default": "1.0"
    },
    "organization": {
      "type": "string",
      "description": "GitHub/GitLab organization name",
      "minLength": 1
    },
    "codex_repo": {
      "type": "string",
      "description": "Codex core repository name (e.g., codex.fractary.com)",
      "pattern": "^codex\\.[a-zA-Z0-9-]+\\.[a-z]{2,}$"
    },
    "sync_patterns": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Glob patterns for files to sync to/from codex",
      "default": [
        "docs/**",
        "CLAUDE.md",
        "README.md",
        ".claude/**"
      ]
    },
    "exclude_patterns": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Glob patterns for files to exclude from sync",
      "default": [
        "**/.git/**",
        "**/node_modules/**",
        "**/.env",
        "**/*.log"
      ]
    },
    "auto_sync": {
      "type": "boolean",
      "description": "Enable automatic sync on repository changes",
      "default": false
    },
    "sync_direction": {
      "type": "string",
      "enum": ["to-codex", "from-codex", "bidirectional"],
      "description": "Default sync direction for operations",
      "default": "bidirectional"
    },
    "handlers": {
      "type": "object",
      "description": "Handler configuration for sync mechanisms",
      "properties": {
        "sync": {
          "type": "object",
          "properties": {
            "active": {
              "type": "string",
              "enum": ["github", "vector", "mcp"],
              "description": "Active sync handler (github: script-based, vector: vector DB, mcp: MCP server)",
              "default": "github"
            },
            "options": {
              "type": "object",
              "description": "Handler-specific configuration options",
              "properties": {
                "github": {
                  "type": "object",
                  "properties": {
                    "parallel_repos": {
                      "type": "integer",
                      "description": "Maximum number of repositories to sync in parallel",
                      "minimum": 1,
                      "maximum": 20,
                      "default": 5
                    },
                    "deletion_threshold": {
                      "type": "integer",
                      "description": "Maximum number of files that can be deleted in a single sync before requiring confirmation",
                      "minimum": 1,
                      "default": 50
                    },
                    "deletion_threshold_percent": {
                      "type": "number",
                      "description": "Maximum percentage of files that can be deleted (0-100)",
                      "minimum": 0,
                      "maximum": 100,
                      "default": 20
                    },
                    "sparse_checkout": {
                      "type": "boolean",
                      "description": "Use git sparse checkout for efficiency (only clone sync patterns)",
                      "default": true
                    },
                    "retry_attempts": {
                      "type": "integer",
                      "description": "Number of retry attempts for failed sync operations",
                      "minimum": 0,
                      "maximum": 10,
                      "default": 3
                    },
                    "retry_delay": {
                      "type": "integer",
                      "description": "Delay in seconds between retry attempts",
                      "minimum": 1,
                      "default": 5
                    }
                  }
                },
                "vector": {
                  "type": "object",
                  "description": "Vector database sync configuration (future)",
                  "properties": {
                    "provider": {
                      "type": "string",
                      "enum": ["pinecone", "weaviate", "qdrant"],
                      "description": "Vector database provider"
                    },
                    "endpoint": {
                      "type": "string",
                      "description": "Vector database endpoint URL"
                    }
                  }
                },
                "mcp": {
                  "type": "object",
                  "description": "MCP server sync configuration (future)",
                  "properties": {
                    "server_url": {
                      "type": "string",
                      "description": "MCP server URL"
                    }
                  }
                }
              }
            }
          },
          "required": ["active"]
        }
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging and audit configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable audit logging of sync operations",
          "default": true
        },
        "log_file": {
          "type": "string",
          "description": "Path to audit log file (relative to project root or absolute)",
          "default": ".fractary/plugins/codex/logs/audit.log"
        },
        "level": {
          "type": "string",
          "enum": ["debug", "info", "warn", "error"],
          "description": "Logging level",
          "default": "info"
        }
      }
    },
    "notifications": {
      "type": "object",
      "description": "Notification configuration for sync events",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable notifications",
          "default": false
        },
        "on_success": {
          "type": "boolean",
          "description": "Notify on successful sync",
          "default": false
        },
        "on_failure": {
          "type": "boolean",
          "description": "Notify on failed sync",
          "default": true
        },
        "webhook_url": {
          "type": "string",
          "description": "Webhook URL for notifications (Slack, Discord, etc.)",
          "format": "uri"
        }
      }
    },
    "cache": {
      "type": "object",
      "description": "Cache configuration for knowledge retrieval (SPEC-00030)",
      "properties": {
        "ttl_days": {
          "type": "integer",
          "description": "Default time-to-live for cached documents in days",
          "minimum": 1,
          "maximum": 365,
          "default": 7
        },
        "max_size_mb": {
          "type": "integer",
          "description": "Maximum cache size in megabytes (0 = unlimited)",
          "minimum": 0,
          "default": 0
        },
        "auto_cleanup": {
          "type": "boolean",
          "description": "Automatically remove expired cache entries",
          "default": true
        },
        "cleanup_interval_days": {
          "type": "integer",
          "description": "Interval in days between automatic cleanup runs",
          "minimum": 1,
          "maximum": 30,
          "default": 7
        }
      }
    },
    "sources": {
      "type": "array",
      "description": "Multi-source configuration for knowledge retrieval (Phase 2)",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Unique source identifier",
            "minLength": 1
          },
          "type": {
            "type": "string",
            "enum": ["codex", "external-url", "s3", "local"],
            "description": "Source type"
          },
          "handler": {
            "type": "string",
            "enum": ["github", "http", "s3", "local"],
            "description": "Handler to use for fetching"
          },
          "handler_config": {
            "type": "object",
            "description": "Handler-specific configuration",
            "properties": {
              "org": {"type": "string"},
              "repo": {"type": "string"},
              "branch": {"type": "string", "default": "main"},
              "base_path": {"type": "string", "default": "projects"},
              "url_pattern": {"type": "string"},
              "bucket": {"type": "string"},
              "region": {"type": "string"},
              "path_prefix": {"type": "string"}
            }
          },
          "url_pattern": {
            "type": "string",
            "description": "URL pattern for external sources (supports ** wildcard)"
          },
          "cache": {
            "type": "object",
            "description": "Source-specific cache settings",
            "properties": {
              "ttl_days": {
                "type": "integer",
                "minimum": 1,
                "maximum": 365,
                "default": 7
              }
            }
          },
          "permissions": {
            "type": "object",
            "description": "Permission configuration for this source",
            "properties": {
              "enabled": {
                "type": "boolean",
                "description": "Enable frontmatter-based permission checking",
                "default": false
              },
              "default": {
                "type": "string",
                "enum": ["allow", "deny", "check_frontmatter"],
                "description": "Default permission when frontmatter missing",
                "default": "check_frontmatter"
              }
            }
          }
        },
        "required": ["name", "type", "handler"]
      },
      "minItems": 1
    }
  },
  "required": ["version", "organization", "codex_repo"],
  "additionalProperties": false
}
