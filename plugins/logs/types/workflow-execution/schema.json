{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "title": "Workflow Execution Log Schema",
  "description": "Schema for aggregated workflow execution summaries. Created at workflow completion with totals, phase summaries, and references to individual step-response logs.",
  "properties": {
    "log_type": {
      "const": "workflow-execution",
      "description": "Must be 'workflow-execution'"
    },
    "execution_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this execution summary"
    },
    "workflow_id": {
      "type": "string",
      "description": "Workflow identifier",
      "pattern": "^workflow-[a-z0-9-]+$"
    },
    "run_id": {
      "type": "string",
      "description": "Unique run identifier (format: org/project/uuid)"
    },
    "target": {
      "type": "string",
      "description": "What was worked on (artifact name, module, description)"
    },
    "work_id": {
      "type": ["string", "null"],
      "description": "Associated work item ID (issue/ticket number)"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "Workflow start timestamp (ISO 8601)"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "Workflow completion timestamp (ISO 8601)"
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Total workflow duration in milliseconds"
    },
    "final_status": {
      "type": "string",
      "enum": ["completed", "completed_with_warnings", "failed", "cancelled", "paused"],
      "description": "Final workflow status"
    },
    "autonomy": {
      "type": "object",
      "description": "Autonomy configuration used for this run",
      "properties": {
        "check_in_frequency": {
          "type": "string",
          "enum": ["per-step", "per-phase", "end-only"],
          "description": "How often workflow paused for review"
        },
        "warning_tolerance": {
          "type": "string",
          "enum": ["none", "low", "medium", "high"],
          "description": "Max warning severity tolerated"
        },
        "error_tolerance": {
          "type": "string",
          "enum": ["none", "low", "medium", "high"],
          "description": "Max error severity tolerated"
        }
      }
    },
    "phases_summary": {
      "type": "object",
      "description": "Summary of each phase execution",
      "properties": {
        "frame": { "$ref": "#/definitions/phase_summary" },
        "architect": { "$ref": "#/definitions/phase_summary" },
        "build": { "$ref": "#/definitions/phase_summary" },
        "evaluate": { "$ref": "#/definitions/phase_summary" },
        "release": { "$ref": "#/definitions/phase_summary" }
      }
    },
    "totals": {
      "type": "object",
      "description": "Aggregated totals across all phases",
      "properties": {
        "steps_total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total steps executed"
        },
        "steps_succeeded": {
          "type": "integer",
          "minimum": 0,
          "description": "Steps that succeeded"
        },
        "steps_warned": {
          "type": "integer",
          "minimum": 0,
          "description": "Steps that completed with warnings"
        },
        "steps_failed": {
          "type": "integer",
          "minimum": 0,
          "description": "Steps that failed"
        },
        "hooks_total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total hooks executed"
        },
        "warnings": {
          "type": "integer",
          "minimum": 0,
          "description": "Total warnings collected"
        },
        "errors": {
          "type": "integer",
          "minimum": 0,
          "description": "Total errors collected"
        },
        "warnings_by_severity": {
          "$ref": "#/definitions/severity_counts"
        },
        "errors_by_severity": {
          "$ref": "#/definitions/severity_counts"
        },
        "warnings_by_category": {
          "$ref": "#/definitions/category_counts"
        },
        "errors_by_category": {
          "$ref": "#/definitions/category_counts"
        },
        "retries_used": {
          "type": "integer",
          "minimum": 0,
          "description": "Total retry attempts used"
        }
      }
    },
    "aggregated_warnings": {
      "type": "array",
      "description": "All warnings collected across workflow execution",
      "items": {
        "$ref": "#/definitions/aggregated_warning"
      }
    },
    "aggregated_errors": {
      "type": "array",
      "description": "All errors collected (when tolerated) across workflow execution",
      "items": {
        "$ref": "#/definitions/aggregated_error"
      }
    },
    "step_response_refs": {
      "type": "array",
      "description": "References to individual step-response log entries",
      "items": {
        "type": "string",
        "description": "Log ID or file path to step-response log"
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Artifacts created during workflow",
      "properties": {
        "branch_name": { "type": "string" },
        "worktree_path": { "type": "string" },
        "spec_path": { "type": "string" },
        "pr_number": { "type": "string" },
        "pr_url": { "type": "string" },
        "commits": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": true
    },
    "recommended_actions": {
      "type": "array",
      "description": "Prioritized list of recommended actions from aggregated issues",
      "items": {
        "type": "object",
        "properties": {
          "priority": {
            "type": "integer",
            "minimum": 1
          },
          "description": {
            "type": "string"
          },
          "source_step": {
            "type": "string"
          },
          "command": {
            "type": "string"
          },
          "file": {
            "type": "string"
          }
        },
        "required": ["priority", "description"]
      }
    }
  },
  "required": ["log_type", "execution_id", "run_id", "started_at", "final_status", "phases_summary", "totals"],
  "additionalProperties": true,
  "definitions": {
    "phase_summary": {
      "type": "object",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["success", "warning", "failure", "skipped", "not_run"],
          "description": "Phase outcome"
        },
        "steps_total": {
          "type": "integer",
          "minimum": 0
        },
        "steps_succeeded": {
          "type": "integer",
          "minimum": 0
        },
        "warnings": {
          "type": "integer",
          "minimum": 0
        },
        "errors": {
          "type": "integer",
          "minimum": 0
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "severity_counts": {
      "type": "object",
      "properties": {
        "low": { "type": "integer", "minimum": 0 },
        "medium": { "type": "integer", "minimum": 0 },
        "high": { "type": "integer", "minimum": 0 }
      }
    },
    "category_counts": {
      "type": "object",
      "properties": {
        "deprecation": { "type": "integer", "minimum": 0 },
        "performance": { "type": "integer", "minimum": 0 },
        "security": { "type": "integer", "minimum": 0 },
        "style": { "type": "integer", "minimum": 0 },
        "compatibility": { "type": "integer", "minimum": 0 },
        "validation": { "type": "integer", "minimum": 0 },
        "configuration": { "type": "integer", "minimum": 0 },
        "other": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": { "type": "integer", "minimum": 0 }
    },
    "aggregated_warning": {
      "type": "object",
      "properties": {
        "phase": { "type": "string" },
        "step_id": { "type": "string" },
        "text": { "type": "string" },
        "severity": { "type": "string", "enum": ["low", "medium", "high"] },
        "category": { "type": "string" },
        "analysis": { "type": "string" },
        "suggested_fix": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" }
      },
      "required": ["phase", "step_id", "text", "severity", "category"]
    },
    "aggregated_error": {
      "type": "object",
      "properties": {
        "phase": { "type": "string" },
        "step_id": { "type": "string" },
        "text": { "type": "string" },
        "severity": { "type": "string", "enum": ["low", "medium", "high"] },
        "category": { "type": "string" },
        "analysis": { "type": "string" },
        "suggested_fix": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" }
      },
      "required": ["phase", "step_id", "text", "severity", "category"]
    }
  }
}
